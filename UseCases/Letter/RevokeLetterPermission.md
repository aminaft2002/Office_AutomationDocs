

### 🎯 هدف:

لغو یا حذف یک سطح دسترسی خاص که قبلاً به یک کاربر برای یک نامه داده شده است.

---

### 🧩 پیش‌نیازها:

|شرط|توضیح|
|---|---|
|نامه باید وجود داشته باشد|بررسی `LetterId`|
|کاربر هدف باید قبلاً مجوز مربوطه را دریافت کرده باشد|وجود `LetterPermission` برای `TargetUserId`|
|کاربر درخواست‌دهنده باید مجوز `ManagePermissions` داشته باشد|بررسی از طریق `LetterPermission`|
|عدم تلاش برای حذف دسترسی خودش در صورتی که تنها دارنده‌ی مجوز `ManagePermissions` باشد|جلوگیری از قفل شدن نامه|

---

### 📥 ورودی‌ها (Input)

|فیلد|نوع|الزامی؟|توضیح|
|---|---|---|---|
|`LetterId`|`Guid`|✅|شناسه نامه|
|`TargetUserId`|`Guid`|✅|کاربری که باید دسترسی‌اش لغو شود|
|`PermissionType`|`LetterPermissionType`|✅|نوع دسترسی برای لغو|
|`RequestedByUserId`|`Guid`|✅|کاربری که این عملیات را انجام می‌دهد|

---

### ⚙️ مراحل اجرایی

1. بررسی وجود نامه با `LetterId`
    
2. بررسی اینکه `TargetUserId` دارای `PermissionType` برای این نامه هست
    
3. بررسی اینکه `RequestedByUserId` دسترسی `ManagePermissions` دارد
    
4. بررسی اینکه حذف دسترسی منجر به قفل شدن نامه نشود (مثلاً آخرین مدیر دسترسی نباشد)
    
5. حذف رکورد `LetterPermission` مربوطه
    
6. ثبت لاگ در `LetterLog` با نوع `PermissionRevoked`
    

---

### 📤 خروجی (Output)

|فیلد|نوع|توضیح|
|---|---|---|
|`Success`|`bool`|موفقیت عملیات|
|`Errors`|`List<string>`|لیست خطاها در صورت وجود|
|`RevokedPermissionId`|`Guid?`|شناسه مجوز لغوشده، در صورت موفقیت|

---

### 🛡️ کنترل‌های امنیتی

- فقط دارندگان دسترسی `ManagePermissions` مجاز به لغو هستند.
    
- سیستم نباید اجازه دهد آخرین کاربر دارای `ManagePermissions` دسترسی خودش را حذف کند.
    

---

### 🔄 ارتباط با مدل‌ها

- `Letter`
    
- `User`
    
- `LetterPermission`
    
- `LetterLog` (برای ردیابی عملیات)