
### 📄 Use Case: DownloadAttachment

|ویژگی|مقدار|
|---|---|
|**نام یوزکیس**|DownloadAttachment|
|**هدف**|اجازه دادن به کاربر برای دانلود یک فایل پیوست خاص از یک نامه|
|**Actor**|کاربر دارای دسترسی به نامه و پیوست مربوطه|
|**Trigger**|کاربر روی دکمه دانلود یکی از پیوست‌های نامه کلیک می‌کند|

---

### 🧩 Preconditions (پیش‌نیازها):

- پیوست با شناسه مشخص وجود داشته باشد.
    
- پیوست به نامه‌ای تعلق داشته باشد که کاربر مجاز به مشاهده آن باشد.
    

---

### ⚙️ Main Flow (روند اصلی):

1. کاربر درخواست دانلود فایل پیوست مشخص‌شده با `AttachmentId` را ارسال می‌کند.
    
2. سیستم ابتدا وجود فایل پیوست را بررسی می‌کند.
    
3. سپس بررسی می‌شود که کاربر مجاز به مشاهده نامه‌ی مربوطه هست یا خیر.
    
4. اگر مجاز باشد، یک لینک امن (Signed URL) برای دانلود فایل تولید می‌شود.
    
5. فایل پیوست در اختیار کاربر قرار می‌گیرد.
    

---

### 🔄 Alternative Flow (روند جایگزین):

|شماره|شرط|روند جایگزین|
|---|---|---|
|A1|پیوست یافت نشد|خطای `404 - Attachment Not Found` نمایش داده می‌شود|
|A2|کاربر مجاز به مشاهده نامه نیست|خطای `403 - Access Denied` نمایش داده می‌شود|
|A3|فایل روی فضای ذخیره‌سازی حذف شده یا آسیب‌دیده است|خطای `410 - File Unavailable` یا پیغام جایگزین مناسب نمایش داده شود|

---

### 📦 Output (خروجی):

- **نوع پاسخ:** `application/octet-stream` یا `application/pdf/image/...` بر اساس نوع فایل
    
- **هدر Content-Disposition:** برای وادار کردن مرورگر به دانلود فایل با نام اصلی
    
- **در صورتی که از سیستم توزیع فایل مانند Amazon S3 یا Azure Blob استفاده شود:** URL امضاشده با زمان انقضا (e.g. 10 دقیقه)
    

---

### 🛡️ نکات امنیتی:

- لینک دانلود باید یکبار مصرف یا محدود به زمان باشد.
    
- مسیر ذخیره‌سازی فایل‌ها باید خارج از پوشه‌های عمومی وب باشد.
    
- بررسی دقیق مجوزها (ACL) بر اساس دسترسی کاربر به `Letter` و `Attachment`.
    

---

### 📚 وابستگی‌ها:

- Entity: `LetterAttachment`
    
- Relation: `LetterAttachment → Letter`
    
- بررسی Permission روی `Letter`