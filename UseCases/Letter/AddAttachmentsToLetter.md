
### 🎯 هدف

افزودن فایل‌های پیوست به یک نامه در مرحله پیش‌نویس یا در حال ارسال.

---

### 🧑‍💻 بازیگران (Actors)

- کاربر ایجادکننده نامه
    
- کاربران با مجوز ویرایش نامه‌ها (مثل مدیران دبیرخانه)
    

---

### 🛑 پیش‌نیاز

- نامه باید موجود باشد
    
- کاربر باید دسترسی لازم برای ویرایش نامه را داشته باشد
    
- نامه هنوز نهایی (finalized) نشده باشد
    

---

### ✅ نتیجه موفق

- فایل‌های آپلود شده به نامه متصل می‌شوند
    
- رکوردهای `LetterAttachment` ایجاد می‌شوند
    
- در صورت نیاز، فایل‌ها در سیستم ذخیره‌سازی مرکزی ذخیره می‌شوند
    
- لاگ با عنوان «افزودن پیوست» ثبت می‌گردد
    

---

### ❌ نتیجه ناموفق

- عدم وجود نامه
    
- عدم دسترسی
    
- فایل نامعتبر (فرمت یا حجم)
    
- نامه نهایی شده است (ویرایش ممنوع)
    

---

### 📥 داده‌های ورودی

|فیلد|نوع|الزامی|توضیح|
|---|---|---|---|
|`LetterId`|`Guid`|✅|شناسه نامه|
|`Attachments`|`List<File>`|✅|لیست فایل‌های پیوست|
|`Descriptions`|`List<string>?`|❌|توضیح اختیاری برای هر پیوست|

---

### 🧠 منطق عملکرد

1. بررسی موجود بودن نامه
    
2. بررسی دسترسی کاربر به نامه
    
3. بررسی نهایی نشدن نامه
    
4. اعتبارسنجی فایل‌ها (فرمت، حجم و تعداد)
    
5. ذخیره فایل‌ها در مسیر مشخص
    
6. ایجاد رکورد در `LetterAttachment`
    
7. ثبت در `LetterLog` با پیام "Attachment Added"
    

---

### 🔐 ملاحظات امنیتی

- فقط کاربران دارای نقش مجاز می‌توانند فایل‌ها را اضافه کنند
    
- در صورت فعال بودن سیستم آنتی‌ویروس، فایل‌ها قبل از ذخیره اسکن می‌شوند
    
- فایل‌های محرمانه باید رمزگذاری شوند یا در مسیر محافظت‌شده ذخیره گردند