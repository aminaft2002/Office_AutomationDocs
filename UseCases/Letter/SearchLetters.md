
### جستجوی نامه‌ها بر اساس فیلترها و دسترسی کاربر

---

### 🎯 هدف:

امکان جستجوی نامه‌ها در سیستم بر اساس فیلترهای مختلف (شماره نامه، عنوان، وضعیت، واحد فرستنده، تاریخ، و...) و با رعایت سطوح دسترسی کاربر.

---

### ✅ سناریوهای کاربردی

|سناریو|توضیح|
|---|---|
|جستجو با یک کلیدواژه|مثل "پروژه ملی" در عنوان یا متن|
|فیلتر بر اساس وضعیت|پیش‌نویس، ارسال‌شده، ارجاع‌شده...|
|جستجو در بازه زمانی|بر اساس تاریخ ثبت یا تاریخ نامه|
|ترکیبی از فیلترها|جستجوی پیشرفته با چند شرط هم‌زمان|
|دسترسی محدود|فقط نتایج مجاز برای کاربر نمایش داده می‌شود|

---

### 📥 ورودی‌ها (Input)

|فیلد|نوع|الزامی؟|توضیح|
|---|---|---|---|
|`Keyword`|`string`|❌|جستجوی متنی در عنوان یا متن نامه|
|`LetterNumber`|`string`|❌|جستجو بر اساس شماره نامه|
|`SenderUnitId`|`Guid`|❌|فیلتر بر اساس واحد فرستنده|
|`ReceiverUnitId`|`Guid`|❌|فیلتر بر اساس واحد گیرنده|
|`Status`|`LetterStatus`|❌|وضعیت نامه|
|`Priority`|`LetterPriority`|❌|اولویت نامه|
|`Confidentiality`|`LetterConfidentiality`|❌|سطح محرمانگی|
|`DateFrom`|`DateTime`|❌|از تاریخ|
|`DateTo`|`DateTime`|❌|تا تاریخ|
|`UserId`|`Guid`|✅|شناسه کاربری برای اعمال محدودیت دسترسی|
|`PageIndex`|`int`|✅|صفحه فعلی برای نمایش نتایج|
|`PageSize`|`int`|✅|تعداد در هر صفحه|

---

### ⚙️ مراحل اجرا

1. اعمال فیلترهای ارسالی از سمت کاربر
    
2. بررسی مجوزها و دسترسی‌ها:
    
    - فیلتر نامه‌های قابل مشاهده برای کاربر
        
    - در صورت محرمانگی نامه‌ها، بررسی سطح دسترسی
        
3. مرتب‌سازی نتایج (مثلاً بر اساس تاریخ ثبت)
    
4. بازگردانی نتایج به‌صورت صفحه‌بندی‌شده (Paginated)
    

---

### 📤 خروجی (Output)

|فیلد|نوع|توضیح|
|---|---|---|
|`TotalCount`|`int`|تعداد کل نتایج|
|`PageIndex`|`int`|شماره صفحه فعلی|
|`PageSize`|`int`|تعداد در هر صفحه|
|`Letters`|`List<LetterSummaryDto>`|لیست خلاصه‌ای از نامه‌ها (برای نمایش در لیست)|

---

### 📄 مدل `LetterSummaryDto` (نمونه)

|فیلد|نوع|توضیح|
|---|---|---|
|`LetterId`|`Guid`|شناسه نامه|
|`LetterNumber`|`string`|شماره نامه|
|`Subject`|`string`|موضوع نامه|
|`SenderName`|`string`|نام فرستنده|
|`Status`|`LetterStatus`|وضعیت نامه|
|`IsRead`|`bool`|آیا کاربر آن را خوانده؟|
|`IsConfidential`|`bool`|محرمانه بودن|
|`CreatedAt`|`DateTime`|تاریخ ثبت نامه|

---

### 🔒 نکات مهم امنیتی:

- فقط نامه‌هایی قابل جستجو هستند که کاربر مجوز دیدن آن‌ها را دارد (بر اساس `LetterPermission`, واحد سازمانی، نقش کاربر و سطح محرمانگی).
    
- اطلاعاتی مانند پیوست‌ها، متن کامل و امضای دیجیتال فقط در جزییات نمایش داده می‌شوند، نه در نتایج جستجو.