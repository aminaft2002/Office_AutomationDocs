

### ارسال رسمی نامه از سوی کاربر به گیرنده/گیرندگان مشخص

---

### 🎯 هدف:

کاربر بتواند نامه‌ای که قبلاً در حالت پیش‌نویس یا داخلی بوده را به‌صورت رسمی ارسال کند و روند گردش نامه آغاز شود.

---

### ✅ سناریوهای کاربردی

|سناریو|توضیح|
|---|---|
|ارسال نامه صادره به سازمان دیگر|همراه با شماره رسمی|
|ارسال نامه داخلی به واحد دیگر|همراه با ثبت در مسیر ارجاع|
|تغییر وضعیت نامه از "پیش‌نویس" به "ارسال‌شده"|و ثبت لاگ و تاریخچه|

---

### 📥 ورودی‌ها (Input)

|فیلد|نوع|الزامی؟|توضیح|
|---|---|---|---|
|`LetterId`|`Guid`|✅|شناسه نامه‌ای که باید ارسال شود|
|`SenderUserId`|`Guid`|✅|شناسه کاربری ارسال‌کننده|
|`RoutingTargets`|`List<Guid>`|✅|شناسه گیرنده/گیرندگان نامه (ممکن است واحد یا کاربر باشد)|
|`SendAsDraftFinalized`|`bool`|❌|اگر نامه نهایی‌شده اما هنوز ارسال نشده است|
|`IsResponseToLetter`|`bool`|❌|اگر این نامه پاسخ به نامه قبلی باشد، باید `ResponseToLetterId` پر شود|

---

### ⚙️ مراحل اجرا

1. **بررسی اعتبار**:
    
    - آیا کاربر حق ارسال این نامه را دارد؟
        
    - آیا نامه در حالت Draft یا Finalized ولی ارسال‌نشده است؟
        
2. **به‌روزرسانی وضعیت**:
    
    - تغییر `Status` به `Sent` یا `InProgress`
        
    - ثبت زمان `SentDate`
        
3. **ثبت مسیر گردش (Routing)**:
    
    - ایجاد رکوردهای `LetterRouting` برای هر گیرنده
        
4. **به‌روزرسانی سابقه مشاهده و اعلان‌ها**:
    
    - درج رکورد در `LetterNotification` برای کاربران مقصد
        
5. **ثبت لاگ اقدام (LogLetterAction)**
    

---

### 📤 خروجی (Output)

|فیلد|نوع|توضیح|
|---|---|---|
|`Success`|`bool`|آیا ارسال موفق بود؟|
|`Message`|`string`|پیام مناسب برای رابط کاربری|
|`RoutingIds`|`List<Guid>`|شناسه مسیرهای ارجاع ثبت‌شده|
|`UpdatedStatus`|`enum`|وضعیت نهایی نامه (ارسال‌شده یا در گردش)|

---

### 📎 نکات مهم

- اگر گیرنده سازمان خارجی باشد، ممکن است نیاز به ثبت `ExternalLetterNumber` باشد.
    
- اگر نامه پاسخ به یک نامه دیگر باشد، باید رابطه `ResponseToLetterId` برقرار شود.
    
- ثبت در `LetterViewHistory` برای کاربر ایجادکننده لازم نیست (چون ارسال‌کننده محسوب می‌شود).
    
- پس از ارسال، امکان ویرایش یا حذف نامه وجود ندارد (اگر `IsFinalized == true`).
    
- ارسال به چند گیرنده باید به صورت موازی در گردش ثبت شود.