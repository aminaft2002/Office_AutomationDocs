### 🎯 هدف

نمایش جزئیات یک نامه به کاربر مجاز به مشاهده، شامل اطلاعات کلی، پیوست‌ها، مسیر گردش، وضعیت و لاگ‌ها.

---

### 🧑‍💻 بازیگران (Actors)

- گیرنده مستقیم نامه
    
- کاربران دارای مجوز (مثل مدیر، دبیرخانه)
    
- فرستنده نامه
    
- ناظران سیستم یا ثبت‌کنندگان گردش
    

---

### 🛑 پیش‌نیازها

- کاربر باید اجازه مشاهده نامه را داشته باشد
    
- نامه باید در دیتابیس وجود داشته باشد
    

---

### ✅ نتیجه موفق

- اطلاعات کامل نامه به کاربر نمایش داده می‌شود
    
- رکورد `LetterViewHistory` برای کاربر ایجاد می‌شود (در اولین مشاهده)
    
- وضعیت "خوانده‌شده" در صورت اولین بازدید به‌روزرسانی می‌شود (در `LetterRouting`)
    

---

### ❌ نتیجه ناموفق

- عدم وجود نامه
    
- دسترسی نداشتن کاربر به نامه
    
- خطا در بارگذاری پیوست‌ها یا محتوا
    

---

### 📥 داده‌های ورودی

|فیلد|نوع|الزامی|توضیح|
|---|---|---|---|
|`LetterId`|`Guid`|✅|شناسه نامه|
|`ViewerUserId`|`Guid`|✅|شناسه کاربر درخواست‌دهنده|

---

### 📤 داده‌های خروجی

|فیلد|نوع|توضیح|
|---|---|---|
|`LetterHeader`|`object`|اطلاعات کلی نامه: شماره، تاریخ، موضوع، نوع و وضعیت|
|`Body`|`string`|متن کامل نامه|
|`Attachments`|`List<AttachmentDTO>`|لیست فایل‌های پیوست|
|`RoutingStatus`|`List<RoutingDTO>`|وضعیت مسیر ارجاع|
|`Logs`|`List<LogDTO>`|تاریخچه فعالیت‌ها|
|`IsFirstView`|`bool`|اگر اولین بار است که کاربر این نامه را می‌بیند، true|

---

### 🧠 منطق عملکرد

1. بررسی موجود بودن نامه
    
2. بررسی دسترسی کاربر به نامه
    
3. جمع‌آوری اطلاعات کامل نامه از جداول مختلف (`Letter`, `LetterAttachment`, `LetterRouting`, `LetterLog`)
    
4. بررسی اینکه آیا قبلاً توسط این کاربر دیده شده است؟
    
    - اگر نه، ذخیره `LetterViewHistory`
        
    - اگر مسیر ارجاع داشته باشد، به‌روزرسانی وضعیت `Routing` به "خوانده‌شده"
        
5. ساخت خروجی نهایی و ارسال به فرانت‌اند
    

---

### 🔐 ملاحظات امنیتی

- هر درخواست مشاهده باید بررسی شود که کاربر گیرنده، فرستنده یا دارای مجوز باشد
    
- در نامه‌های محرمانه، فیلدها یا پیوست‌های خاص ممکن است مخفی شوند
    
- در صورت عبور از زمان اعتبار، نمایش نامه ممکن است مسدود شود