
### ๐ Use Case: ValidateLetterBeforeSend

|ูฺฺฏ|ููุฏุงุฑ|
|---|---|
|**ูุงู ูุฒฺฉุณ**|ValidateLetterBeforeSend|
|**ูุฏู**|ุจุฑุฑุณ ุตุญุช ู ฺฉุงูู ุจูุฏู ุงุทูุงุนุงุช ูุงูู ูุจู ุงุฒ ุงุฑุณุงู ุฑุณู|
|**Actor**|ฺฉุงุฑุจุฑ ุงุฑุณุงูโฺฉููุฏูุ ุณุณุชู (ูุจู ุงุฒ ุนููุงุช Send)|
|**Trigger**|ฺฉุงุฑุจุฑ ุฏฺฉูู "ุงุฑุณุงู ูุงูู" ุฑุง ูโุฒูุฏ ุง API ูุฑุจูุทู ูุฑุงุฎูุงู ูโุดูุฏ|

---

### ๐งฉ Preconditions (ูพุดโูุงุฒูุง):

- ูุงูู ุฏุฑ ูุถุนุช `Draft` ุง `Registered` ุจุงุดุฏ.
    
- ฺฉุงุฑุจุฑ ุฏุณุชุฑุณ ฺฉุงู ุจุฑุง ุงุฑุณุงู ูุงูู ุฑุง ุฏุงุดุชู ุจุงุดุฏ.
    
- ููุฏูุง ุถุฑูุฑ ุจุงุฏ ูพุฑ ุดุฏู ุจุงุดูุฏ.
    

---

### โ Validation Rules (ููุงูู ุงุนุชุจุงุฑุณูุฌ):

|ุดุฑุท|ุชูุถุญ|
|---|---|
|`Subject` ูุจุงุฏ ุฎุงู ุจุงุดุฏ|ุนููุงู ูุงูู ุงุฌุจุงุฑ ุงุณุช|
|`Body` ุจุงุฏ ุญุฏุงูู ฺฉ ูพุงุฑุงฺฏุฑุงู ุฏุงุดุชู ุจุงุดุฏ|ูุญุชูุง ูุงูู ุจุงุฏ ูุดุฎุต ุจุงุดุฏ|
|`SenderUnitId` ู `CreatorUserId` ุจุงุฏ ููุฏุงุฑ ุฏุงุดุชู ุจุงุดูุฏ|ูุฑุณุชูุฏู ูุดุฎุต ุจุงุดุฏ|
|`LetterType` ููุฏุงุฑ ูุนุชุจุฑ ุจุงุดุฏ|ููุน ูุงูู ูุดุฎุต ุดูุฏ|
|ุงฺฏุฑ `LetterType == Outgoing` ุง `Incoming`|ุจุงุฏ ุญุฏุงูู ฺฉ ฺฏุฑูุฏู ูุดุฎุต ุจุงุดุฏ|
|ุงฺฏุฑ `IsConfidential == true`|ุจุงุฏ ุฏุณุชุฑุณ ุฎุงุต ุชูุธู ุดุฏู ุจุงุดุฏ (`LetterPermissions`)|
|ุงฺฏุฑ `LetterTemplateId` ุชูุธู ุดุฏู ุจุงุดุฏ|ุณุงุฎุชุงุฑ ูุชู ุจุงุฏ ุจุง ุงูฺฏู ุชุทุงุจู ุฏุงุดุชู ุจุงุดุฏ (ุงุฎุชุงุฑ)|
|ูพูุณุชโูุง ุงฺฏุฑ ุงุฌุจุงุฑ ุจุงุดูุฏ (ุจูุง ุจุฑ ุชูุธูุงุช ุณุณุชู)|ุญุฏุงูู ฺฉ `Attachment` ุจุงุฏ ุซุจุช ุดุฏู ุจุงุดุฏ|
|ุงฺฏุฑ ูุงูู ูพุงุณุฎ ุจู ูุงููโุง ุฏฺฏุฑ ุงุณุช (`ResponseToLetterId`)|ูุงูู ูุฑุฌุน ุจุงุฏ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ ู ุจุณุชู ูุดุฏู ุจุงุดุฏ|

---

### โ๏ธ Main Flow (ุฑููุฏ ุงุตู):

1. ุณุณุชู ูุงูู ููุฑุฏ ูุธุฑ ุฑุง ุจุงุฑฺฏุฐุงุฑ ูโฺฉูุฏ.
    
2. ููุงุนุฏ ุงุนุชุจุงุฑุณูุฌ ุจุงูุง ุจูโุชุฑุชุจ ุจุฑุฑุณ ูโุดููุฏ.
    
3. ุฏุฑ ุตูุฑุช ุนุจูุฑ ุงุฒ ุชูุงู ุดุฑูุทุ ูพุงุณุฎ `Valid` ุจุงุฒฺฏุฑุฏุงูุฏู ูโุดูุฏ.
    
4. ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ูพุงู ุฎุทุง ุดุงูู ูุณุช ุงุดฺฉุงูุงุช ุจุงุฒฺฏุฑุฏุงูุฏู ูโุดูุฏ.
    

---

### ๐ Alternative Flow (ุฌุงฺฏุฒูโูุง):

|ุดูุงุฑู|ุดุฑุท|ูุชุฌู|
|---|---|---|
|A1|`Subject` ุฎุงู ุงุณุช|ูพุงู ุฎุทุง: `SubjectIsRequired`|
|A2|ฺฏุฑูุฏู ูุดุฎุต ูุณุช|ูพุงู: `ReceiverMissing`|
|A3|ุฏุณุชุฑุณโูุง ูุงูู ุชูุธู ูุดุฏู|ูพุงู: `LetterPermissionRequired`|
|A4|ูุงูุจ ูุงูู ุจุง ุงูฺฏู ุชุทุงุจู ูุฏุงุฑุฏ|ูพุงู: `TemplateMismatchException`|
|A5|ูุงูู ูุจูุงู ุงุฑุณุงู ุดุฏู|ูพุงู: `LetterAlreadySent` ู ุชููู ุนููุงุช|

---

### ๐ฆ Output (ุฎุฑูุฌ ููููู):

{
  "isValid": false,
  "errors": [
    "Subject is required",
    "Receiver is missing",
    "Confidential letter must have explicit permissions"
  ]
}


### ๐ ูฺฉุงุช ุงููุช:

- ุจุฑุฑุณ ูโุดูุฏ ฺฉู ฺฉุงุฑุจุฑ ูุฌูุฒ ุจุฑุฑุณ ุง ุงุฑุณุงู ุงู ูุงูู ุฑุง ุฏุงุดุชู ุจุงุดุฏ.
    
- ูุชุฌู ุงุนุชุจุงุฑุณูุฌ ูุจุงุฏ ุงุทูุงุนุงุช ูุญุฑูุงูู ุจู ฺฉุงุฑุจุฑ ุบุฑูุฌุงุฒ ุงุฑุงุฆู ุฏูุฏ.
    

---

### ๐ ูุงุจุณุชฺฏโูุง:

- Entity: `Letter`
    
- Table: `LetterPermissions`, `LetterRecipients`
    
- Setting: `LetterTemplate`, `LetterConfidentialityPolicy`