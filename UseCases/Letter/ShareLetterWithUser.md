### ✅ اطلاعات پایه

|ویژگی|مقدار|
|---|---|
|🎯 نام یوزکیس|ShareLetterWithUser|
|🧩 دامنه مرتبط|Letter, LetterPermission|
|🎯 هدف|اشتراک‌گذاری یک نامه خاص با یک یا چند کاربر جهت مشاهده یا انجام اقدامات خاص|
|👤 استفاده‌کننده|فرستنده نامه، مالک نامه، یا کاربران دارای مجوز اشتراک‌گذاری|
|🔐 پیش‌نیاز دسترسی|کاربر باید مجاز به اشتراک‌گذاری آن نامه باشد (مالک یا با مجوز خاص)|

---

### 📝 توضیح کلی

در این یوزکیس، یک کاربر مجاز می‌تواند نامه‌ای را با کاربر(ها)ی دیگر به اشتراک بگذارد و برای آن‌ها سطح دسترسی مشخصی تعریف کند، مانند فقط مشاهده، ویرایش، پاسخ‌دهی، یا ارجاع.

---

### ✅ ورودی‌ها

|ورودی|نوع|توضیح|
|---|---|---|
|`LetterId`|`Guid`|شناسه نامه موردنظر|
|`UserId`|`Guid`|شناسه کاربری که می‌خواهد نامه را به اشتراک بگذارد|
|`TargetUserId(s)`|`Guid[]`|شناسه یک یا چند کاربر مقصد|
|`PermissionType`|`enum`|نوع دسترسی اعطاشده (ReadOnly, ReadWrite, Reply, Forward, etc.)|
|`Note`|`string?`|یادداشت اختیاری برای اشتراک‌گذاری|

---

### 🎯 خروجی

|خروجی|نوع|توضیح|
|---|---|---|
|`Success`|`bool`|نتیجه عملیات|
|`Message`|`string`|پیام نتیجه (مثلاً «با موفقیت به اشتراک گذاشته شد»)|

---

### 🧠 قوانین و شرط‌ها

- فقط کاربران دارای مجوز می‌توانند نامه‌ای را با دیگران به اشتراک بگذارند.
    
- نباید نامه به کاربری که قبلاً همان دسترسی را دارد، دوباره با همان دسترسی اختصاص یابد (پرهیز از تکرار).
    
- اگر سطح دسترسی کاربر جدید بیشتر از مالک فعلی باشد، باید خطا یا هشدار صادر شود (مثلاً دسترسی بیشتر از خود فرستنده).
    

---

### 🔧 مکانیزم پیشنهادی

- ذخیره در جدول `LetterPermission` با فیلدهای `LetterId`, `UserId`, `PermissionType`, `GrantedBy`, `GrantedAt`.
    
- استفاده از soft delete برای لغوهای بعدی (`IsRevoked = true`).
    

---

### 🔗 ارتباط با سایر یوزکیس‌ها

- مکمل: `RevokeLetterPermission`
    
- وابسته به: `CheckUserCanShareLetter`, `AuditLetterPermissionChange`