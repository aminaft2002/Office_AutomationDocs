
### 🎯 هدف:

امکان ارسال (ارجاع) یک نامه موجود به کاربر یا واحد دیگر، با امکان افزودن توضیح ارجاع، تعیین سطح دسترسی، و تعیین مسیر بعدی گردش نامه (Routing).

---

### 🧩 پیش‌نیازها:

|شرط|توضیح|
|---|---|
|نامه باید موجود باشد|بررسی `LetterId`|
|کاربر ارسال‌کننده باید دسترسی ارسال یا ارجاع داشته باشد|بررسی از `LetterPermission`|
|گیرنده نباید قبلاً در لیست گیرندگان نامه باشد (مگر در ارجاع مجدد با مسیر متفاوت)|برای جلوگیری از ارسال تکراری به یک مسیر|
|وضعیت نامه باید قابل ارسال باشد|مثلاً نباید در حالت بسته یا بایگانی‌شده باشد مگر استثناء تعریف شده|

---

### 📥 ورودی‌ها (Input)

|فیلد|نوع|الزامی؟|توضیح|
|---|---|---|---|
|`LetterId`|`Guid`|✅|شناسه نامه‌ای که باید ارسال شود|
|`FromUserId`|`Guid`|✅|کاربر ارسال‌کننده|
|`ToUserId` یا `ToUnitId`|`Guid`|✅|گیرنده مستقیم نامه|
|`RoutingNote`|`string?`|❌|توضیح اضافه ارجاع|
|`PermissionType`|`LetterPermissionType`|✅|نوع مجوزی که به گیرنده داده می‌شود|
|`Deadline`|`DateTime?`|❌|مهلت انجام برای گیرنده|
|`ForwardType`|`enum`|✅|نوع ارجاع: مستقیم، جهت اقدام، جهت اطلاع|
|`IsFinal`|`bool`|❌|آیا این ارجاع پایان مسیر نامه است؟ (برای تشخیص پایان فرآیند)|

---

### ⚙️ مراحل اجرایی

1. بررسی وجود نامه با `LetterId`
    
2. بررسی اینکه `FromUserId` دارای دسترسی کافی برای ارسال است
    
3. بررسی صحت `ToUserId` یا `ToUnitId`
    
4. بررسی عدم وجود ارجاع مشابه
    
5. ایجاد رکورد جدید در `LetterRouting`
    
6. ایجاد رکورد جدید در `LetterPermission` برای گیرنده
    
7. به‌روزرسانی `Letter.hasReplies = true`
    
8. ثبت لاگ در `LetterLog` با نوع `Forwarded`
    

---

### 📤 خروجی (Output)

|فیلد|نوع|توضیح|
|---|---|---|
|`Success`|`bool`|موفقیت عملیات|
|`Errors`|`List<string>`|لیست خطاها در صورت وجود|
|`RoutingId`|`Guid`|شناسه مسیر ارجاع جدید|
|`GrantedPermissionId`|`Guid`|شناسه سطح دسترسی داده شده به گیرنده|

---

### 🛡️ کنترل‌های امنیتی

- ارسال‌کننده باید دسترسی ارجاع (`CanForward`) یا دسترسی مدیریتی داشته باشد.
    
- سیستم از ارجاع به خود یا ارجاع حلقه‌ای جلوگیری می‌کند.
    
- محرمانگی نامه در ارجاع بررسی می‌شود (فقط افراد مجاز می‌توانند ببینند).
    

---

### 🔄 ارتباط با مدل‌ها

- `Letter`
    
- `User` / `Unit`
    
- `LetterRouting`
    
- `LetterPermission`
    
- `LetterLog`