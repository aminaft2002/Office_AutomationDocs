
### 🎯 هدف:

اختصاص یک سطح دسترسی مشخص به یک کاربر یا نقش خاص برای یک نامه.

---

### 🧩 پیش‌نیازها:

|شرط|توضیح|
|---|---|
|نامه باید وجود داشته باشد|بررسی `LetterId`|
|کاربر درخواست‌دهنده باید مجوز مدیریت دسترسی‌ها داشته باشد|بررسی `LetterPermission` برای `ManagePermissions`|
|کاربر هدف باید معتبر باشد (و نباید خود کاربر ایجادکننده نامه باشد، در صورت لزوم)|بررسی `TargetUserId`|
|مجوز قبلاً اختصاص نیافته باشد (برای جلوگیری از تکرار)|بررسی موجودیت `LetterPermission` قبلی|

---

### 📥 ورودی‌ها (Input)

|فیلد|نوع|الزامی؟|توضیح|
|---|---|---|---|
|`LetterId`|`Guid`|✅|شناسه نامه|
|`TargetUserId`|`Guid`|✅|کاربری که قرار است دسترسی بگیرد|
|`PermissionType`|`LetterPermissionType`|✅|نوع دسترسی (مثل Read, Comment, Forward, Refer, ManagePermissions, Delete)|
|`RequestedByUserId`|`Guid`|✅|کاربری که این عملیات را انجام می‌دهد|

---

### ⚙️ مراحل اجرایی

1. بررسی وجود نامه با `LetterId`
    
2. بررسی وجود کاربر هدف با `TargetUserId`
    
3. بررسی مجوز `ManagePermissions` برای کاربر درخواست‌دهنده
    
4. بررسی عدم وجود رکورد قبلی مشابه در `LetterPermission`
    
5. ایجاد رکورد جدید `LetterPermission`
    
6. ثبت لاگ عملیات در `LetterLog` با نوع `PermissionAssigned`
    

---

### 📤 خروجی (Output)

|فیلد|نوع|توضیح|
|---|---|---|
|`Success`|`bool`|موفقیت عملیات|
|`Errors`|`List<string>`|لیست خطاهای احتمالی|
|`AssignedPermissionId`|`Guid?`|در صورت موفقیت، شناسه دسترسی اختصاص‌یافته|

---

### 🛡️ کنترل‌های امنیتی

- فقط کاربری که دسترسی `ManagePermissions` دارد می‌تواند دسترسی‌های دیگر را تخصیص دهد.
    
- کاربران نمی‌توانند به خودشان مجوزهای اضافی دهند (قابل تنظیم بر اساس سیاست سیستم).
    

---

### 🔄 ارتباط با مدل‌ها

- `Letter`
    
- `User`
    
- `LetterPermission`
    
- `LetterLog` (برای ثبت فعالیت‌ها)