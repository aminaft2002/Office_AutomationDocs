



### 🎯 هدف:

کاربر بتواند تاریخچه ارجاع نامه را مشاهده کند؛ یعنی ببیند نامه در چه زمان‌هایی، توسط چه افرادی، به کجا ارجاع داده شده و وضعیت فعلی آن در کدام واحد یا نزد کدام کاربر است.

---

### 🧩 پیش‌نیازها:

|شرط|توضیح|
|---|---|
|نامه باید وجود داشته باشد|بررسی `LetterId` در سیستم|
|کاربر باید دسترسی مشاهده نامه را داشته باشد|براساس مجوزها یا نقش‌ها|
|تاریخچه ارجاع باید قبلاً ثبت شده باشد|از طریق `LetterRouting` یا `LetterFlow`|

---

### 📥 ورودی‌ها (Input)

|فیلد|نوع|الزامی؟|توضیح|
|---|---|---|---|
|`LetterId`|`Guid`|✅|شناسه نامه موردنظر برای ردیابی|
|`RequestedByUserId`|`Guid`|✅|کاربر درخواست‌کننده|

---

### ⚙️ مراحل اجرایی

1. بررسی وجود نامه با `LetterId`
    
2. بررسی دسترسی کاربر به مشاهده‌ی نامه
    
3. دریافت تاریخچه ارجاع از جدول `LetterRouting` (یا `LetterFlow`)
    
4. ساخت یک لیست زمانی (timeline) از مسیر طی‌شده نامه
    
5. نمایش اطلاعات مانند:
    
    - از کدام کاربر / واحد → به کدام کاربر / واحد
        
    - تاریخ ارجاع
        
    - توضیحات ارجاع (در صورت وجود)
        
    - وضعیت نامه در هر مرحله (خوانده شده، اقدام شده، ارجاع بعدی و ...)
        

---

### 📤 خروجی (Output)

|فیلد|نوع|توضیح|
|---|---|---|
|`RoutingSteps`|`List<RoutingStep>`|لیست مراحل ارجاع|
|`CurrentStatus`|`LetterStatus`|وضعیت فعلی نامه|
|`IsFinalDestinationReached`|`bool`|آیا به مقصد نهایی رسیده؟|
|`Errors`|`List<string>`|در صورت خطا|

---

### 📄 مدل RoutingStep (برای نمایش)

|فیلد|نوع|توضیح|
|---|---|---|
|`FromUserId`|`Guid`|کاربر ارجاع‌دهنده|
|`ToUserId`|`Guid`|کاربر دریافت‌کننده|
|`FromUnitId`|`Guid?`|واحد فرستنده|
|`ToUnitId`|`Guid?`|واحد گیرنده|
|`ForwardDate`|`DateTime`|تاریخ ارجاع|
|`Note`|`string`|توضیحات ارجاع|
|`StatusAtThisStep`|`enum`|وضعیت نامه در این گام|
|`IsSeen`|`bool`|توسط گیرنده خوانده شده؟|

---

### 🧱 ارتباط با مدل‌ها

- `Letter` → برای دریافت کلیات نامه
    
- `LetterRouting` → تاریخچه ارجاع
    
- `User` و `Unit` → برای نمایش نام کاربر و واحد مربوطه
    

---

### 🛡️ امنیت و سطح دسترسی

|سناریو|نیازمندی|
|---|---|
|مشاهده مسیر|مجوز `ViewLetterRouting` یا عضویت در زنجیره ارجاع|
|مشاهده کامل جریان|فقط مدیر یا مالک اصلی نامه|

---

### 💡 نکته:

می‌توان این Use Case را با امکانات پیشرفته‌تری ترکیب کرد مانند:

- نمایش گرافیکی مسیر ارجاع
    
- نمایش مدت زمان توقف نامه در هر مرحله
    
- هشدار در صورت توقف بیش از حد در یک مرحله (برای گزارش تخلف یا ناکارآمدی)