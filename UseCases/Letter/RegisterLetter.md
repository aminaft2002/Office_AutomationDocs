

|جزئیات|مقدار|
|---|---|
|**نام یوزکیس**|RegisterLetter|
|**هدف**|ثبت یک نامه جدید به‌صورت پیش‌نویس یا نهایی در سیستم|
|**Actors**|کاربر ایجادکننده نامه (CreatorUser)|
|**پیش‌نیاز**|کاربر احراز هویت شده باشد|
|**نتیجه موفق**|یک رکورد جدید در `Letter` ایجاد می‌شود|
|**نتیجه ناموفق**|ارور اعتبارسنجی یا خطای دسترسی|


📥 ورودی‌ها (Input)

|فیلد|نوع|اجباری؟|توضیح|
|---|---|---|---|
|`Subject`|`string`|✅|عنوان نامه|
|`Body`|`string`|✅|متن اصلی نامه|
|`LetterType`|`enum`|✅|نوع نامه (داخلی، صادره، وارده)|
|`Priority`|`enum`|⬜|عادی / فوری / خیلی فوری|
|`Confidentiality`|`enum`|⬜|عادی / محرمانه / خیلی محرمانه|
|`ReceiverUserId`|`Guid`|⬜|کاربر گیرنده (در صورت نیاز)|
|`SenderUnitId`|`Guid`|✅|واحد ارسال‌کننده|
|`LetterDate`|`DateTime`|⬜|تاریخ رسمی درج‌شده در نامه|
|`IsFinalized`|`bool`|✅|آیا نامه به‌صورت نهایی ذخیره شود؟|
|`Tags`|`List<Guid>`|⬜|برچسب‌های انتخابی|
|`Attachments`|`List<File>`|⬜|فایل‌های پیوست|
|`ResponseToLetterId`|`Guid?`|⬜|در صورت پاسخ به نامه‌ای دیگر|

## ✅ مراحل منطقی Use Case

1. احراز هویت کاربر بررسی می‌شود.
    
2. ورودی‌ها اعتبارسنجی می‌شوند.
    
3. رکورد `Letter` جدید ساخته می‌شود:
    
    - `CreatorUserId = currentUser.Id`
        
    - `CreatedAt = now`
        
4. اگر `IsFinalized == true`:
    
    - وضعیت نامه به `Sent` تنظیم می‌شود.
        
    - شماره نامه تولید می‌شود (الگوریتم `LetterNumberGenerator`)
        
5. اگر `Tags` داده شده:
    
    - رکوردهای مربوط در `LetterTagAssignment` ایجاد می‌شوند.
        
6. اگر `Attachments` داده شده:
    
    - فایل‌ها ذخیره و به `LetterAttachment` متصل می‌شوند.
        
7. رکورد `LetterLog` با عنوان “نامه ایجاد شد” ثبت می‌شود.
    
8. در صورت `IsFinalized == true`، `Notification` به گیرنده ارسال می‌شود.
    

---

## ⚠️ نکات امنیتی

- فقط کاربران دارای **سطح دسترسی ساخت نامه** می‌توانند از این یوزکیس استفاده کنند.
    
- در صورت `IsConfidential == true`، دسترسی پیش‌فرض به نامه محدود می‌شود.