
### 🎯 هدف:

کاربر بتواند یک نظر، توضیح یا یادداشت داخلی به نامه‌ای خاص اضافه کند. این نظر ممکن است برای اطلاع دیگر کاربران یا برای نگهداری سوابق باشد.

---

### 🧩 پیش‌نیازها:

|شرط|توضیح|
|---|---|
|نامه باید موجود باشد|بررسی وجود `LetterId` در سیستم|
|کاربر باید دسترسی مشاهده نامه را داشته باشد|بررسی `LetterPermission` یا نقش سیستمی|
|نوع نظر باید مشخص باشد (داخلی/سیستمی/قابل نمایش)|اختیاری ولی توصیه‌شده|

---

### 📥 ورودی‌ها (Input)

|فیلد|نوع|الزامی؟|توضیح|
|---|---|---|---|
|`LetterId`|`Guid`|✅|شناسه نامه‌ای که نظر به آن تعلق دارد|
|`CommentText`|`string`|✅|متن یادداشت یا نظر|
|`CreatedByUserId`|`Guid`|✅|کاربر ایجادکننده|
|`CommentType`|`enum`|❌|نوع نظر: داخلی، سیستمی، یادداشت مدیر، هشدار|
|`IsInternal`|`bool`|❌|اگر فقط برای کاربران خاص قابل نمایش باشد|
|`CreatedAt`|`DateTime`|❌|زمان ثبت (در صورت نیاز می‌توان از زمان سیستم استفاده کرد)|

---

### ⚙️ مراحل اجرایی

1. بررسی وجود نامه با `LetterId`
    
2. بررسی مجوز دسترسی کاربر به نامه
    
3. ذخیره `LetterComment` جدید در دیتابیس
    
4. در صورت نیاز، اطلاع‌رسانی به سایر کاربران مرتبط با نامه (Notification اختیاری)
    
5. ثبت لاگ در `LetterLog` با نوع `Commented`
    

---

### 📤 خروجی (Output)

|فیلد|نوع|توضیح|
|---|---|---|
|`CommentId`|`Guid`|شناسه یادداشت ثبت‌شده|
|`Success`|`bool`|موفقیت یا شکست عملیات|
|`Errors`|`List<string>`|خطاهای احتمالی|

---

### 🔄 ارتباط با مدل‌ها

- `Letter` ← نگهداری ارتباط با کامنت‌ها
    
- `LetterComment` ← مدل اصلی نظر
    
- `User` ← ایجادکننده یادداشت
    
- `LetterLog` ← لاگ سیستم در صورت نیاز
    

---

### 🛡️ امنیت و سطح دسترسی

|سناریو|نیازمندی|
|---|---|
|ثبت یادداشت|مجوز مشاهده و نظر دادن|
|نمایش یادداشت|بررسی `IsInternal` و نقش کاربر|
|حذف/ویرایش نظر|فقط توسط ایجادکننده یا ادمین‌ها مجاز باشد|

---

### 🧱 مدل پیشنهادی: `LetterComment`

|فیلد|نوع|توضیح|
|---|---|---|
|`Id`|`Guid`|شناسه یکتا|
|`LetterId`|`Guid`|ارتباط به نامه|
|`CommentText`|`string`|متن نظر|
|`CreatedByUserId`|`Guid`|ایجادکننده|
|`CommentType`|`enum`|نوع نظر|
|`IsInternal`|`bool`|فقط برای کاربران خاص قابل نمایش است؟|
|`CreatedAt`|`DateTime`|زمان ثبت|