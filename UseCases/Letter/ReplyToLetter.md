### 🎯 هدف:

کاربر بتواند در پاسخ به یک نامه دریافتی، نامه‌ای جدید ایجاد کند که به‌عنوان پاسخ ثبت شود. این نامه باید شامل لینک به نامه اصلی، و همچنین اطلاعات ارسال جدید باشد.

---

### 🧩 پیش‌نیازها:

|شرط|توضیح|
|---|---|
|نامه اصلی باید موجود باشد|بررسی وجود `OriginalLetterId`|
|کاربر باید اجازه پاسخ‌دهی داشته باشد|بررسی `LetterPermission`|
|نامه اصلی باید قابلیت پاسخ‌پذیری داشته باشد|مثل نبودن در وضعیت بسته یا بدون مجوز پاسخ|

---

### 📥 ورودی‌ها (Input)

|فیلد|نوع|الزامی؟|توضیح|
|---|---|---|---|
|`OriginalLetterId`|`Guid`|✅|شناسه نامه‌ای که باید پاسخ داده شود|
|`SenderUserId`|`Guid`|✅|کاربر پاسخ‌دهنده|
|`SenderUnitId`|`Guid?`|❌|واحد فرستنده (در صورت نیاز)|
|`Subject`|`string`|✅|موضوع نامه پاسخ|
|`Body`|`string`|✅|متن نامه پاسخ|
|`Priority`|`enum`|❌|اولویت نامه|
|`Confidentiality`|`enum`|❌|محرمانگی|
|`Attachments`|`List<File>`|❌|فایل‌های پیوست|
|`ReceiverUserId` یا `ReceiverUnitId`|`Guid`|✅|گیرنده پاسخ|
|`PermissionType`|`LetterPermissionType`|✅|نوع دسترسی برای گیرنده|
|`ForwardType`|`enum`|❌|پاسخ جهت اقدام یا اطلاع|

---

### ⚙️ مراحل اجرایی

1. بررسی وجود `OriginalLetterId` در سیستم
    
2. بررسی مجوز پاسخ‌دهی توسط `SenderUserId`
    
3. ایجاد نامه جدید (`Letter`) با پر شدن فیلد `ResponseToLetterId = OriginalLetterId`
    
4. کپی برخی ویژگی‌ها از نامه اصلی (در صورت تعریف رویه مانند Subject prefix یا رونوشت)
    
5. ایجاد مسیر اولیه در `LetterRouting` به گیرنده پاسخ
    
6. تنظیم دسترسی در `LetterPermission`
    
7. افزودن پیوست‌ها در `LetterAttachment` (در صورت وجود)
    
8. به‌روزرسانی فیلد `HasReplies = true` در نامه اصلی
    
9. ثبت لاگ جدید در `LetterLog` با نوع `Replied`
    

---

### 📤 خروجی (Output)

|فیلد|نوع|توضیح|
|---|---|---|
|`NewLetterId`|`Guid`|شناسه نامه پاسخ‌دهی شده|
|`Success`|`bool`|وضعیت موفقیت عملیات|
|`Errors`|`List<string>`|لیست خطاها در صورت وجود|

---

### 🔄 ارتباط با مدل‌ها

- `Letter` ← ایجاد نامه پاسخ با `ResponseToLetterId`
    
- `LetterRouting` ← مسیر اولیه برای ارسال پاسخ
    
- `LetterPermission` ← سطح دسترسی برای گیرنده پاسخ
    
- `LetterAttachment` ← پیوست‌های جدید
    
- `LetterLog` ← ثبت لاگ پاسخ‌دهی
    

---

### 🛡️ امنیت و کنترل دسترسی

- بررسی اینکه کاربر اجازه مشاهده و پاسخ‌دهی به نامه اصلی را دارد.
    
- بررسی اینکه نامه اصلی قابل پاسخ باشد (مثلاً بایگانی نشده).
    
- رعایت محرمانگی در پاسخ (پاسخ نمی‌تواند محرمانگی کمتری از نامه اصلی داشته باشد مگر مجاز باشد).