
### 🎯 هدف

ویرایش یک نامه ثبت‌شده (تا قبل از نهایی‌سازی).

---

### 🧑‍💻 بازیگران (Actors)

- کاربر احراز هویت‌شده
    
- کاربر ایجادکننده نامه (CreatorUser)
    

---

### 🛑 پیش‌نیاز

- کاربر باید صاحب نامه باشد (`CreatorUserId`)
    
- نامه هنوز `IsFinalized == false` باشد
    

---

### ✅ نتیجه موفق

- اطلاعات نامه به‌روزرسانی می‌شود
    
- پیوست‌ها و برچسب‌ها در صورت تغییر، آپدیت می‌شوند
    
- یک لاگ با عنوان «ویرایش نامه» ثبت می‌شود
    

---

### ❌ نتیجه ناموفق

- دسترسی غیرمجاز
    
- نامه قبلاً نهایی شده است
    
- خطای اعتبارسنجی فیلدها
    

---

### 📥 داده‌های ورودی

|فیلد|نوع|الزامی|توضیح|
|---|---|---|---|
|LetterId|Guid|✅|شناسه نامه|
|Subject|string|⬜|موضوع جدید|
|Body|string|⬜|متن جدید|
|Priority|enum|⬜|اولویت|
|Confidentiality|enum|⬜|محرمانگی|
|ReceiverUserId|Guid|⬜|گیرنده جدید|
|Tags|List<Guid>|⬜|برچسب‌های جدید|
|Attachments|List<File>|⬜|پیوست‌های جدید|
|LetterDate|DateTime|⬜|تاریخ نامه جدید|

---

### 🧠 منطق عملکرد

1. بررسی مالکیت نامه و عدم نهایی بودن آن
    
2. به‌روزرسانی فیلدهای قابل ویرایش
    
3. حذف و ثبت مجدد تگ‌ها در `LetterTagAssignment` (در صورت تغییر)
    
4. حذف و بارگذاری مجدد `LetterAttachment` (در صورت تغییر)
    
5. ثبت رویداد در `LetterLog` با عنوان: «ویرایش نامه»
    
6. بروزرسانی `UpdatedAt`
    

---

### 🔐 ملاحظات امنیتی

- فقط کاربری که نامه را ایجاد کرده اجازه ویرایش دارد
    
- نامه نهایی‌شده قابل ویرایش نیست
    
- فایل‌های پیوست قبلی پاک می‌شوند (در صورت تعویض)